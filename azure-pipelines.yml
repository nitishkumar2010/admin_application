# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none

variables:
- group: vm-ssh-secrets

pool:
  vmImage: ubuntu-latest

steps:
- script: |
    set -e
    echo "Setting up SSH..."
    mkdir -p ~/.ssh
    printf "%s\n" "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    chmod 600 ~/.ssh/id_ed25519
    ssh-keyscan -H $(VM_IP) >> ~/.ssh/known_hosts
    echo "Testing connection..."
    ssh -i ~/.ssh/id_ed25519 \
        -o StrictHostKeyChecking=yes \
        $(VM_USER)@$(VM_IP) "echo CONNECTED && hostname"

  displayName: Test SSH From Pipeline


